@model E_Diary.WEB.Data.Entities.TeacherGroupSubject
@using E_Diary.WEB.Data.Entities
@using System.Globalization
@inject E_Diary.WEB.Data.ASPIdentityDBContext context;
@{
    Teacher teacher = context.Teachers.FirstOrDefault(
        t => t.User.UserName == User.Identity.Name
    );
}
<nav class="mb-4">
    <div class="border border-dark rounded-2">
        <div class="container-fluid d-flex">
            <div class="col-1 border-end border-dark" valign="middle" width="120px">
                <h3 class="fw-bold mt-4 mb-4 text-center">
                    @Model.Group.Year@Model.Group.Literal
                </h3>
            </div>
            <div class="col-6 ms-2 mt-2" valign="middle">
                <div class="selection selection-choose-classes">
                    @foreach (TeacherGroupSubject tgs in context.TeacherGroupSubjects.AsEnumerable()
                    .Where(t => t.Teacher.Id == teacher.Id).DistinctBy(t => t.Group.Id))
                    {
                        if (tgs.Group.Id == Model.Group.Id)
                        {
                            <span class="btn btn-outline-primary btn-outline-darkborder active"
                                  style="pointer-events:none" data-toggle="button"
                                  aria-pressed="true" autocomplete="off" role="button">
                                @tgs.Group.Year@tgs.Group.Literal
                            </span>
                        }
                        else
                        {
                            <a asp-action="Index" asp-route-groupId="@tgs.Group.Id"
                               class="btn btn-outline-primary btn-outline-darkborder"
                               data-toggle="button" aria-pressed="false"
                               autocomplete="off" role="button">
                                @tgs.Group.Year@tgs.Group.Literal
                            </a>
                        }
                    }
                </div>
            </div>
            <div class="col-5 ms-2 mt-2" valign="middle">
                <div class="selection selection-choose-classes">
                    @foreach (TeacherGroupSubject tgs in context.TeacherGroupSubjects.AsEnumerable()
                    .Where(t => t.Teacher.Id == teacher.Id && t.Group.Id == Model.Group.Id))
                    {
                        if (tgs.Subject.Id == Model.Subject.Id)
                        {
                            <span class="btn btn-outline-primary btn-outline-darkborder active"
                                  style="pointer-events:none" data-toggle="button"
                                  aria-pressed="true" autocomplete="off" role="button">
                                @tgs.Subject.Name
                            </span>
                        }
                        else
                        {
                            <a asp-action="Index"
                               asp-route-groupId="@Model.Group.Id"
                               asp-route-subjectId="@tgs.Subject.Id"
                               class="btn btn-outline-primary btn-outline-darkborder"
                               data-toggle="button" aria-pressed="false"
                               autocomplete="off" role="button">
                                @tgs.Subject.Name
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</nav>


<div class="container-fluid d-flex flex-column">
    <div class="container-fluid d-flex">
        <h2>@Model.Subject.Name</h2>
    </div>
    <div class="container-fluid d-flex flex-column">
        <div class="container-fluid d-flex p-0 m-0 border-bottom border-dark">
            @*header*@
            <div class="col-2 flex-grow-1 border-end border-dark"></div>
            <div class="col-10 container-fluid d-flex p-0 m-0 text-center">
                @foreach (Lesson lesson in context.Lessons.Where(l => l.LessonInfo.Id == Model.Id))
                {
                    <div class="p-0 m-0 d-flex row row-cols-1 border-end border-secondary"
                         style="width:2.5rem;">
                        <div class="col p-0 m-0">@lesson.Date.Day</div>
                        <div class="col p-0 m-0">
                            @(
                                new string(CultureInfo.CurrentCulture.DateTimeFormat
                                .MonthGenitiveNames[lesson.Date.Month - 1].Take(3).ToArray())
                                )
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="container-fluid p-0 m-0 d-flex flex-column">
            @*body*@
            @{
                var students = context.Students.Where(s => s.Group.Id == Model.Group.Id).ToList();
            }
            @for (int i = 0; i < students.Count(); i++)
            {
                string borderClass = i == students.Count() - 1 ? "border-dark" : "border-secondary";

                <div class="container-fluid p-0 m-0 d-flex col-12 border-bottom @borderClass" style="height:2.5rem;">
                    <div class="col-2 container-fluid p-0 m-0 d-flex">
                        <div class="text-muted ms-2 pe-1">@(i + 1)</div>
                        <div class="flex-grow-1 border-end border-secondary">@students[i].User.Surname @students[i].User.Name</div>
                    </div>
                    <div class="col-10 container-fluid d-flex p-0 m-0 text-center">
                        @foreach (Lesson lesson in context.Lessons.Where(l => l.LessonInfo.Id == Model.Id))
                        {
                            <div class="grade border-end border-secondary position-relative" style="width:2.5rem;">
                                <div class="bg-secondary p-2 mt-2" id="gradeFormDiv" style="display:none; width:7.5rem; z-index:100; position:absolute; left:-100%; top:95%;">
                                    <form asp-action="SetGrade" asp-controller="Grade" class="m-0 p-0 container-fluid d-flex flex-wrap">
                                        @for (int g = 1; g <= 5; g++)
                                        {
                                            <input type="radio" class="btn-check" name="grade" id="grade @g" value="@g" autocomplete="off" onclick="if(grade_val=='@g'){ this.checked = false; grade_val = '';}else{grade_val = '@g'};">
                                            <label class="btn btn-secondary" for="grade @g">@g</label>
                                        }
                                        @*< div class="input-group mb-2">
                                <input name="AuthString" type="tel" placeholder="Номер телефона" />
                                </div>
                                <div class="input-group mb-2">
                                <input name="Password" type="password" placeholder="Пароль" />
                                </div>
                                <span id="errorLoginSpan" class="text-danger small text-center"></span>
                                <div class="container">
                                <div class="row mb-2">
                                <div class="col-12 d-flex justify-content-center align-self-center">
                                <button type="submit" id="authButton" class="btn bg-secondary bg-opacity-25">Войти</button>
                                </div>
                                </div>
                                <div class="row d-flex">
                                <div class="col-6 d-flex justify-content-start align-self-start p-0">
                                <a asp-action="Register" asp-controller="Account" style="font-size:.77rem;">Регистрация</a>
                                </div>
                                <div class="col-6 d-flex justify-content-end align-self-end p-0">
                                <a asp-action="GetResetPasswordLink" asp-controller="Account" style="font-size:.77rem;">Забыли пароль?</a>
                                </div>
                                </div>
                                </div> *@
                                    </form>
                                </div>
                            </div>
                        }
                    </div>

                </div>
            }
        </div>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let grade_val;
        $(document).ready(() => {
            
            $('.grade').on('click', ShowChildGradeForm);
        })
        function HideChildGradeForm(e) {
             if (e.target !== this)
                 return;
            $(this).children('#gradeFormDiv').eq(0).css('display', 'none');
            $(this).on('click', ShowChildGradeForm);
        }
        function ShowChildGradeForm(e) {
            //$('.grade').each(HideChildGradeForm);

            $(this).children('#gradeFormDiv').css('display', 'block');
            $(this).on('click', HideChildGradeForm);
        }
        // $(document).ready(() => {
        //     var
        // });
    </script>
}

